---
title: 'Statistical Methods for Discrete Response, Time Series, and Panel Data (W271): Lab 2'
subtitle: James Darmody, Maria Vasiliadis and Gaurav Desai
geometry: margin=1in
output:
  pdf_document:
    latex_engine: xelatex
  number_sections: yes
  html_document: default
  toc: yes
fontsize: 11pt
---

```{r warning=FALSE}
library(knitr)
opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)

# Start with a clean R environment
rm(list = ls())

# Set Fixed random seed to replicate the results
set.seed(28740)

#library(ggplot2)
library(Hmisc)
#library(car)
#library(gridExtra)
library(dplyr)
#library(scales)
#library(GGally)
#library(MASS)
#library(purrr)
#library(tidyr)
#library(nnet)
```

# The Keeling Curve

In the 1950s, the geochemist Charles David Keeling observed a seasonal pattern in the amount of carbon dioxide present in air samples collected over the course of several years. He was able to attribute this pattern to the difference in the amount of land area and vegetation cover between the northern and southern hemipsheres, and the resulting variation in global rates of photosynthesis as the hemispheres' seasons alternated throughout the year. 

In 1958 Keeling began continuous monitoring of atmospheric carbon dioxide concentrations from the Mauna Loa Observatory in Hawaii and soon observed a trend increase carbon dioxide levels in addition to the seasonal cycle. He was able to attribute this trend increase to growth in global rates of fossil fuel combustion. This trend has continued to the present.

The `co2` data set in R's `datasets` package (automatically loaded with base R) is a monthly time series of atmospheric carbon dioxide concentrations measured in ppm (parts per million) at the Mauna Loa Observatory from 1959 to 1997. The curve graphed by this data is known as the 'Keeling Curve'.

```{r}
plot(co2, ylab = expression("CO2 ppm"), col = 'blue', las = 1)
title(main = "Monthly Mean CO2 Variation")
```

\newpage

**Part 1 (4 points)**

Conduct a comprehensive Exploratory Data Analysis on the `co2` series. This should include thorough analyses of the trend, seasonal and irregular elements. Trends both in levels and growth rates should be discussed.

**Answer**
```{r}
head(co2)
tail(co2)
str(co2)
summary(co2)
hist(co2)

co2.ts <- as_tsibble(co2)
summary(co2.ts)

#plot(co2.ts, type="l")
autoplot(co2.ts)
co2.components <- stats::decompose(co2) 
co2.components$random %>% autoplot()
co2.components$random[c(11:16)]  %>% gg_tsdisplay(plot_type = "partial")
acf(co2.components$random, na.action = na.omit)
pacf(co2.components$random, na.action = na.omit) # residuals still have lot of autocorrelations
pacf(co2.ts) # indicates seasonal component
pacf(co2.ts) # indicates AR(1) component
co2.ts %>% model(STL(value)) %>% components() %>% autoplot()
co2.ts %>% gg_tsdisplay(plot_type = "partial")
co2.ts %>% ggplot(aes(x = value)) + geom_histogram()

co2.ts %>%
  gg_season(y=value, period = "year")+
  ylab("CO2 emission")+
    ggtitle("Seasonal plot : Monthly CO2 emission")
# higher CO2 emissions in April to June and dip in September-October probably due to differnce in northan hemisphere and southern hemisphere attributes (like population, vegotation etc.)
# also year on year the patter is increasing

co2.ts %>%
  gg_subseries(y=value, period = "year")+
  ylab("CO2 emission")+
  xlab("Years")+
  ggtitle("Seasonal subseries plot : Monthly CO2 emission")
#Same observations as above

co2.ts %>%
  gg_lag(y=value, period = "year")

co2.ts %>% 
  ACF(y=value, lag_max = 48) %>%
  autoplot() #positive autocorrelations for large number of lags indicate seasonality. 
# The seasonality autocorelation is at highest 12 months apart and drop s at around 6 months interval.

lambda <- co2.ts %>%
  features(value, features=guerrero) %>%
  pull(lambda_guerrero)
co2.ts %>% autoplot(box_cox(value, lambda))
co2.ts.comp <- co2.ts %>% model(STL(box_cox(value, lambda))) 

co2.ts.comp %>% components() %>% autoplot()

co2.ts.comp %>% components() %>%
  gg_subseries(y=season_year)

# Lets look ate residuals

co2.ts.comp  %>% components() %>% select("remainder") %>%
  ggplot(aes(x=remainder)) +geom_histogram()

co2.ts.comp  %>% components() %>% select("remainder") %>%
  autoplot()
  
co2.ts.comp  %>% components() %>% select("remainder") %>%
  gg_tsdisplay()
```

**Part 2 (3 points)**

Fit a linear time trend model to the `co2` series, and examine the characteristics of the residuals. Compare this to a quadratic time trend model. Discuss whether a logarithmic transformation of the data would be appropriate. Fit a suitable polynomial time trend model that incorporates seasonal dummy variables, and use this model to generate forecasts to the year 2020. 

**Part 3 (3 points)**

Following all appropriate steps, choose an ARIMA model to fit to the series. Discuss the characteristics of your model and how you selected between alternative ARIMA specifications. Write your model (or models) using backshift notation. Use your model (or models) to generate forecasts to the year 2020. 

**Part 4 (4 points)**

The file `co2_weekly_mlo.txt` contains weekly observations of atmospheric carbon dioxide concentrations measured at the Mauna Loa Observatory from 1974 to 2020, published by the National Oceanic and Atmospheric Administration (NOAA). Convert these data into a suitable time series object, conduct a thorough EDA on the data, and address the problem of missing observations. Describe how the Keeling Curve evolved from 1997 to the present and compare current atmospheric CO2 levels to those predicted by your forecasts in Parts 2 and 3. Use the weekly data to generate a month-average series from 1997 to the present, and compare the overall forecasting performance of your models from Parts 2 and 3 over the entire period.  

**Part 5 (3 points)**

Seasonally adjust the weekly NOAA data, and split both seasonally-adjusted (SA) and non-seasonally-adjusted (NSA) series into training and test sets, using the last two years of observations as the test sets. For both SA and NSA series, fit ARIMA models using all appropriate steps. Measure and discuss how your models perform in-sample and (psuedo-) out-of-sample, comparing candidate models and explaining your choice. In addition, fit a polynomial time-trend model to the seasonally-adjusted series and compare its performance to that of your ARIMA model.

**Part 6 (3 points)**

Generate predictions for when atmospheric CO2 is expected to be at 420 ppm and 500 ppm levels for the first and final times (consider prediction intervals as well as point estimates in your answer). Generate a prediction for atmospheric C02 levels in the year 2100. How confident are you that these are accurate predictions?










